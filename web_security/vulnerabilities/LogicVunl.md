# 逻辑漏洞

​		逻辑漏洞就是基于开发人员设计程序的时候，逻辑不严密，导致攻击者可以修改、绕过或者中断整个程序，让程序按照开发人员的预料之外去执行。

​		逻辑漏洞的分类：漏洞的本质上将逻辑漏洞分为两类

			- 软件(系统)设计之初便存在的漏洞
			- 使用者未能安全使用软件所产生的

## 一、身份验证漏洞

### 1、暴力破解漏洞

#### 1.1 未限制爆破

​		直接使用bp抓包放进intruder模块爆破

#### 1.2 验证码限制

​		当登录界面需要使用验证码时，可以使用 bp 的第三方插件或自己写脚本来爆破

​		bp 插件：captcha-killer-modified-0.16-jdk11.jar

​		自己编写脚本：*https://github.com/sml2h3/ddddocr*

```python
# pip install ddddocr 先安装验证码识别库
import ddddocr
ocr = ddddocr.Ddddocr()
with open('a.png', 'rb') as f:
    img_bytes = f.read()
res = ocr.classification(img_bytes)

print(res)
```

#### 1.3 限制IP爆破

​		某些具有安全意识的开发人员或运维人员，针对账户爆破问题就会使用限制攻击者IP的方式，当在短时间内有大量来自该IP的尝试登录现象时就会封锁该IP，导致该IP无法使用.

​		针对这种情况，建议自己写脚本，调用git开源的代理API来爆破，当然也可以直接用别人的轮子

```python
import requests
import re

def post():
    curl = "http://192.168.1.121/xxx/login.php"
    proxy = {'http': '127.0.0.1:8080'}
    header = {'User-Agent' :'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome'}
    post = requests.get(curl, headers=header, proxies=proxy)
    print(post)
    
if __name__ == "__main__":
    post()
```

​		自建轮子的方法:首先需要新建一个代理池:现在好用的一般是收费版本，可以自行购买

#### 1.4 限制密码错误次数

​		有些网站管理员会限制某个账号的登录次数，如果超过限制次数，账号就会被锁定，除非管理员解锁或者设定一段时间过后自动解锁

​		由于他限制了一个账号，比如只允许输5次，但是不限制你换个账号又可以输错5次。

​		对于这种情况，通常可以采用弱密码反过来爆破账户的方式，即设置任意的不超过爆破次数的弱密码数量来反过来爆破用户名

#### 1.5 多字段爆破

​		多字段爆破即需要爆破多个字段大于等于2，比如说：需要同时爆破：账号密码验证码，当我们爆破一个网站时返回信息是用户名或密码错误时，大多数时候仍然使用 burpsuite 的Intruder模块，只是与单个字段爆破选择的模式不同，但是当某几个字段相同的情况下，例如在不仅在 post 内容中确定还要在 cookie 或者 session 或者 token 中确定的时候，也可以自己写脚本解决问题

#### 1.6 密文传输爆破

​		渗透测试中，有时会遇到密码从客户端到服务端中间通过前端 js 代码将密码加密后，在发送给服务器。所以这个时候，我们可以采用bp上自带的加密方法进行加密。

​		常见的加密手法有MD5或者RSA，如果需要JS的复杂加密，也可以读懂 JS 的加密逻辑，自定义 python 进行爆破，或者使用 python 的 pyexecjs 包来自帮助执行 JS 文件复现加密算法

### 2、session 固定攻击

​		会话固定攻击是利用服务器的 Session 不变机制，借他人之手获得认证和授权，然后冒充他人。

​		漏洞原理:在请求登录过程时候，URL 带有一个 session，登录录成功之后会将登录成功的信息绑定到这个 session 中,攻击者可以发送带有 session 的 URL 给相关工作人员诱导其登录，相当于获取了其身份信息

​		漏洞点：在 GET 方法请求登录时候带有 session 值

​		修复思路：只要避免在 URL 中带入 session 信息即可比较有效的防御。另外也要注意 POST 请求中带有 session_id 进行 session 固定攻击，虽然可利用性比较低，但是建议修复如下：测试方法可以直接赋值 session 然后更换浏览器打开或者使用无痕模式打开即可。如果直接访问，不需要登录，说明存在该漏洞

### 3、Cookie 欺骗漏洞

​		通过伪造 cookie 信息能够伪造其他用户进行登录

​		漏洞原理：开发者为了方便，将身份信息/登录信息明文或者只是简单编码、哈希之后存放在cookies中, 网站通过获取得到的 cookies 进行授权或者身份验证

​		漏洞点：cookie 中有明显或者只是简单编码、哈希的字段时候修改 isLogin 值为 1 可以判定为用户已经登录

​		漏洞修复：Cookie不应该存储可理解的身份信息和登录信息。按照规定，cookie 对身份信息和登录信息的存储只能通过存储足够长度的随机字符串进行，避免篡改

### 4、未进行登陆凭证验证

​		有些业务的接口，因为缺少了对用户的登陆凭证的校验或者是校验存在缺陷，导致黑客可以未经授权访问这些敏感信息甚至是越权操作

## 二、登录验证安全

### 1、图形验证码 

#### 1.1 验证码可爆破

​		验证码过于简单，可以直接爆破

#### 1.2 验证码复用

​		验证码复用，即登录失败后验证码不刷新，仍然可以使用上一次发送登录请求时的验证码。存在爆破风险漏洞，如织梦后台的验证码，测试方法如下：抓包后输入对的验证码后，反复发送不同密码查看回包

#### 1.3 验证码绕过

​		验证码绕过，即验证码可以通过逻辑漏洞被绕过，通常分为以下情况

​		案列一：验证码验证返回状态值

​					可BP修改状态值来绕过前端的验证，修改密码页面中存在验证码绕过漏洞

​		案列二：点击获取验证码时，直接在返回包中返回验证码，通过抓包来观察 response 包

### 2、客户端验证

​		查看源代码发现验证码是前端验证码，可以通过直接抓包的方式在 bp 里进行爆破

### 3、前端验证漏洞

​		可以发送成功请求和失败请求，查看回包区别。有关键字段类似 status 或者 isLogin 显示验证成功还是失败，截取回包修改关键字段，判断是否存在前端验证漏洞

### 4、短信轰炸

​		情况一：没有限制时，任意下发短信

​		情况二：有一定时间间隔，但可以无限下发		 

## 三、登录前端验证漏洞

### 1、忘记密码

#### 1.1 找回密码时验证码输入错误

​		第一个：客户重新填验证码。（这是短信炸弹漏洞）

​		第二个：验证码再输一遍。在这种情况下，极易产生验证码爆破漏洞。

​		攻击方法和图片验证码相似,如果是4位,没有多余的防御措借施,直接爆破即可

#### 1.2 客户端验证

​		（1）直接返回明文验证码：输入手机号后，点击获取验证码，在网络中监听到两条 json 数据

​		（2）返回加密后的密码：验证码加密后，加密报文在应答数据包中。返回回客户端，用户解密后即可获取验证码。

#### 1.3 设置新密码时修改别人密码

​		修改密码时可否修改参数 (用户名/邮箱/手机) 达到修改其他用户密码的目的。

### 2、token参数可逆

​		通过邮箱找回密码时，邮件中将出现一个含有 token 的重置URL，该 token 即为重置凭证

​		 从经验来看，开发人员习惯以时间戳、递增序号、关键字段（如邮箱地址）等三类信息之一作为因子，采用某种加密算法或编码生成 token，攻击者可以基于能收集到的关键字段，用常见加密算法计算一遍，以判断是否可以预测出token

​		一般32位的就是 md5 加密，纯数字可能是时间戳

### 3、重置密码

​		在一些大型公司或者学校的的网站上，会有介绍用户注册的指导手册。里面会介绍用户的用户名和默认密码。 

​		这时可以先用默认密码尝试爆破默认密码，或者寻找重置密码的选项。重置密码后，用默认口令尝试登陆。

## 四、任意账号注册

### 1. 未验证邮箱/手机号

​		目前很多应用为了方便用户记录自己的用户名与密码，都可以使用邮箱跟手机号作为登录用户名。因此很多应用在注册的时候就要求用户填写手机号或者邮箱，一般情况下该应用都会发送激活信息，用户在收到激活信息后才能注册。然而有时候开发人员并不去审核邮箱/手机号是否有效，所以可以利用该缺陷，任意注册账号

​		填写邮箱后，并没有在邮箱发现任何激活信息，且直接把邮箱当作用户登录名使用

### 2. 批量注册

​		脚本批量注册造成服务器 dos 应用层攻击，影响网站的正常使用。通常由于无验证码或者验证码不安全导致可以写脚本来批量注册

### 3. 个人信息伪造

​		若出现身份证信息注册，可任意构造，绕过身份证与姓名任意填写。

### 4. 前端验证审核绕过

​		任意填写注册信息，服务端对注册信息进行审核。例如是否存在恶意标签等恶意信息，但是通过返回状态值给前端判断，一旦篡改该值就有可能绕过

​		第一步：使用正常账号修改密码，获取验证码通过时服务器返回的数据，保存该信息

​		第二步：使用 burpsuite 或 fiddle，之后点击确定，服务器会返回验证码错误之类的信息, 使用正确的信息进行替换后再执行,注册成功。

### 5. 邮箱/手机号注册激活验证绕过

​		为防止恶意用户任意注册账户，大多数网站会在用户注册中输入邮箱/手机号后对其真实性进行验证

​		但是有时候返回的验证信息会直接隐藏在返回包中，只是不在前端显示出来，或者是可以通过抓包改包手机号/邮箱，伪造该信息，劫持到验证信息

### 6. 用户名覆盖

​		渗透测试中，某些不严谨的开发人员，对于注册时，当输入用户名时，不会对之前数据库中存在的用户名进行检查

​		登录查看时却获取到数据库中同名用户的其他用户信息，导致其他用户信息泄露，或者由于验证用户名存在时，从前端获取到的数据与从数据库获取到的数据不同，但是往数据库中写入的时候却写了相同的部分 

​		而登陆时，当检测到是管理员用户名就给与管理权限。

## 五、越权

​		越权分为平行越权、垂直越权和交叉越权

### 1. 平行越权

​		权限类型不变，权限 ID 改变

​		水平越权指的是攻击者尝试访问与他拥有相同权限的用户的资源。比如某系统中A账号和B账号都可以访问，但是A账号的个人信息和B账号的个人信息不同，可以理解为A账号和B账号个人资料这个功能上具备水平权限限的划分。此时，A账号通过攻击手段访问了 B账号的个人资料，这就是水平越权漏洞。

### 2. 垂直越权

​		权限 ID 不变，权限类型改变

​		垂直越权指的是一个低级别攻击者尝试访问高级别用户的资源。比如说某个系统分为普通用户和管理员，管理员有系统管理功能，普通用户没有，那我们就可以理解管理功能具备垂直权限划分。如果普通用户能利用某种攻击手段访问到管理功能，那我们就称之为垂直越权。

### 3. 交叉越权

​		改变 ID，也改变权限类型

## 六、其他漏洞

### 1. 数据包重放

​		漏洞介绍：通过数据包重放，可以造成短信轰炸、邮件轰炸、重复提交订单等

​		漏洞原理：后台未进行相关操作的技术导致数据包重放

​		漏洞点：短信验证码、邮件校验、提交订单等功能

​		修复方案：修复思路（针对短信、邮件）构造一个Hashmap<String, short>，存放邮箱或电话号码及对应次数 。只要某个邮箱或者电话号码次数够了，就不能继续发送了。或者计算两次发送的时间间隔，时间过短就不继续发送了

​		通用修复方案：需要建立 token 机制或验证码机制，一次有效

### 2。 条件竞争

​		漏洞介绍：条件竞争是指一个系统的运行结果依赖于不受控制的事件的先后顺序，当这些不受控制的事件并没有按照开发者想要的方式运行时，就可能会出现bug。尤其在当前我们的系统中大量对资源进行共享，如果处理不当的话，就会产生条件竞争漏洞。说的通俗一点，条件竞争涉及到的就是操作系统中所提到的进程或者线程同步的问题，当一个程序的运行的结果依赖于于线程的顺序，处理不当就会发生条件竞争

​		漏洞修复-修复思路：限制同一时间内访问方法的只有单一线程

## 七、SRC中逻辑漏洞检查总结